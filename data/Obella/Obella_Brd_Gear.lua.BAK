function user_job_setup()
	-- Options: Override default values
    state.OffenseMode:options('Normal','Acc')
    state.CastingMode:options('Normal','Resistant','AoE')
    state.IdleMode:options('Normal','NoRefresh','DT')
	state.Weapons:options('None','Naegling')

	-- Adjust this if using the Terpander (new +song instrument)
    info.ExtraSongInstrument = 'Daurdabla'
	-- How many extra songs we can keep from Daurdabla/Terpander
    info.ExtraSongs = 2
	
	-- Set this to false if you don't want to use custom timers.
    state.UseCustomTimers = M(false, 'Use Custom Timers')
	
	WSMap =  {
        ['Naegling'] = 'Savage Blade'
	}

    state.Carol = M{['description']='Carol',
        'Fire Carol', 'Fire Carol II', 'Ice Carol', 'Ice Carol II', 'Wind Carol', 'Wind Carol II',
        'Earth Carol', 'Earth Carol II', 'Lightning Carol', 'Lightning Carol II', 'Water Carol', 'Water Carol II',
        'Light Carol', 'Light Carol II', 'Dark Carol', 'Dark Carol II',
        }

    state.Threnody = M{['description']='Threnody',
        'Fire Threnody II', 'Ice Threnody II', 'Wind Threnody II', 'Earth Threnody II',
        'Ltng. Threnody II', 'Water Threnody II', 'Light Threnody II', 'Dark Threnody II',
        }

    state.Etude = M{['description']='Etude', 'Herculean Etude', 'Sinewy Etude', 'learned Etude', 'Sage Etude',
        'Quick Etude', 'Swift Etude', 'Vivacious Etude', 'Vital Etude', 'Dextrous Etude', 'Uncanny Etude',
        'Spirited Etude', 'Logical Etude', 'Enchanting Etude', 'Bewitching Etude'}
    state.UseEtude = M(false, 'UseEtude')

    state.songa:options('Advancing', 'Victory', 'Honor', 'MinuetV', 'MinuetIV', 'MinuetIII', 'sword', 'blade', 'MinneIV','MinneV','BalladIII','BalladII')
    state.songb:options('Victory', 'Honor', 'MinuetV', 'MinuetIV', 'MinuetIII', 'sword', 'blade', 'MinneIV','MinneV','Advancing','BalladIII','BalladII')
    state.songc:options('MinuetV', 'MinuetIV', 'MinuetIII', 'sword', 'blade', 'MinneIV','MinneV','Advancing','Victory', 'Honor', 'BalladIII','BalladII')
    state.songd:options('MinuetIV', 'MinuetIII', 'sword', 'blade', 'MinneIV','MinneV','Advancing','Victory', 'Honor', 'MinuetV','BalladIII','BalladII')
    state.songe:options('MinuetIII', 'sword', 'blade', 'MinneIV','MinneV','Advancing','Victory', 'Honor', 'MinuetV', 'MinuetIV','BalladIII','BalladII')
    
    sa = {
        ['Advancing'] = 'Advancing March',
        ['Victory'] = 'Victory March',
        ['Honor'] = 'Honor March',
        ['MinuetV'] = 'Valor Minuet V',
        ['MinuetIV'] = 'Valor Minuet IV',
        ['MinuetIII'] = 'Valor Minuet III',
        ['blade'] = 'Blade Madrigal',
        ['sword'] = 'Sword Madrigal',
        ['MinneIV'] = 'Knight\'s Minne IV',
        ['MinneV'] = 'Knight\'s Minne V',
        ['BalladIII'] = 'Mage\'s Ballad III',
        ['BalladII'] = 'Mage\'s Ballad II',
    }
    sb = {
        ['Victory'] = 'Victory March',
        ['Honor'] = 'Honor March',
        ['MinuetV'] = 'Valor Minuet V',
        ['MinuetIV'] = 'Valor Minuet IV',
        ['MinuetIII'] = 'Valor Minuet III',
        ['Madrigal2'] = 'Blade Madrigal',
        ['Madrigal1'] = 'Sword Madrigal',
        ['MinneIV'] = 'Knight\'s Minne IV',
        ['MinneV'] = 'Knight\'s Minne V',
        ['Advancing'] = 'Advancing March',
        ['BalladIII'] = 'Mage\'s Ballad III',
        ['BalladII'] = 'Mage\'s Ballad II',
    }
    sc = {
        ['MinuetV'] = 'Valor Minuet V',
        ['MinuetIV'] = 'Valor Minuet IV',
        ['MinuetIII'] = 'Valor Minuet III',
        ['Madrigal2'] = 'Blade Madrigal',
        ['Madrigal1'] = 'Sword Madrigal',
        ['MinneIV'] = 'Knight\'s Minne IV',
        ['MinneV'] = 'Knight\'s Minne V',
        ['Advancing'] = 'Advancing March',
        ['Victory'] = 'Victory March',
        ['Honor'] = 'Honor March',
        ['BalladIII'] = 'Mage\'s Ballad III',
        ['BalladII'] = 'Mage\'s Ballad II',
    }
    sd = {
        ['MinuetIV'] = 'Valor Minuet IV',
        ['MinuetIII'] = 'Valor Minuet III',
        ['Madrigal2'] = 'Blade Madrigal',
        ['Madrigal1'] = 'Sword Madrigal',
        ['MinneIV'] = 'Knight\'s Minne IV',
        ['MinneV'] = 'Knight\'s Minne V',
        ['Advancing'] = 'Advancing March',
        ['Victory'] = 'Victory March',
        ['Honor'] = 'Honor March',
        ['MinuetV'] = 'Valor Minuet V',
        ['BalladIII'] = 'Mage\'s Ballad III',
        ['BalladII'] = 'Mage\'s Ballad II',
    }
    se = {
        ['MinuetIII'] = 'Valor Minuet III',
        ['Madrigal2'] = 'Blade Madrigal',
        ['Madrigal1'] = 'Sword Madrigal',
        ['MinneIV'] = 'Knight\'s Minne IV',
        ['MinneV'] = 'Knight\'s Minne V',
        ['Advancing'] = 'Advancing March',
        ['Victory'] = 'Victory March',
        ['Honor'] = 'Honor March',
        ['MinuetV'] = 'Valor Minuet V',
        ['MinuetIV'] = 'Valor Minuet IV',
        ['BalladIII'] = 'Mage\'s Ballad III',
        ['BalladII'] = 'Mage\'s Ballad II',
    }
	-- Additional local binds
    send_command('bind ^` gs c cycle ExtraSongsMode')
	send_command('bind !` input /ma "Chocobo Mazurka" <me>')
	send_command('bind @` gs c cycle MagicBurstMode')
	send_command('bind @f10 gs c cycle RecoverMode')
	send_command('bind @f8 gs c toggle AutoNukeMode')
	send_command('bind !q gs c weapons NukeWeapons;gs c update')
	send_command('bind ^q gs c weapons Swords;gs c update')

	select_default_macro_book()
end

function init_gear_sets()

	--------------------------------------
	-- Start defining the sets
	--------------------------------------
	    --Weapons
    Kali_A                  ={ name="Kali", augments={'Mag. Acc.+15','String instrument skill +10','Wind instrument skill +10',}}
    Kali_B                  ={ name="Kali", augments={'DMG:+15','CHR+15','Mag. Acc.+15',}}
    TP_Linos			    ={ name="Linos", augments={'Accuracy+14','"Store TP"+3','Quadruple Attack +3',}}
    --Kaykaus
    Kaykaus_hands           ={ name="Kaykaus Cuffs +1", augments={'MP+80','"Conserve MP"+7','"Fast Cast"+4',}}
    Kaykaus_legs            ={ name="Kaykaus Tights +1", augments={'MP+80','Spell interruption rate down +12%','"Cure" spellcasting time -7%',}}
    Kaykaus_feet            ={ name="Kaykaus Boots +1", augments={'MP+80','Spell interruption rate down +12%','"Cure" spellcasting time -7%',}}
	--Empy
	Empy_head 			    ={ name="Fili Calot +2" }
	Empy_body			    ={ name="Fili Hongreline +2" }
	Empy_hands			    ={ name="Fili Manchettes +1" }
	Empy_legs 			    ={ name="Fili Rhingrave +1" }
	Empy_feet			    ={ name="Fili Cothurnes +1" }
    --AF
    AF_hands                ={ name="Brioso Cuffs +2"}
    AF_legs                 ={ name="Brioso Cann. +2"}
    AF_feet                 ={ name="Brioso Slippers +4"}
    AF_body                 ={ name="Brioso Justau. +2"}
    AF_head                 ={ name="Brioso Roundlet +4"}
    --Relic
    Relic_body              ={ name="Bihu Justaucorps +1"}
    Relic_legs              ={ name="Bihu Cannions +1"}
    Relic_feet              ={ name="Bihu Slippers +1"}
	--Accessories
    
    --Backs
	JSE_FC_back				={ name="Intarabus's Cape", augments={'CHR+20','Mag. Acc+20 /Mag. Dmg.+20','Mag. Acc.+10','"Fast Cast"+10','Damage taken-5%',}}
    JSE_MEVA_back           ={ name="Intarabus's Cape", augments={'HP+60','Eva.+20 /Mag. Eva.+20','Mag. Evasion+7','Enmity-10','Occ. inc. resist. to stat. ailments+6',}}
	JSE_TP_back				={ name="Intarabus's Cape", augments={'DEX+20','Accuracy+20 Attack+20','Accuracy+10','"Dual Wield"+10','Phys. dmg. taken-10%',}}
	JSE_Savage_back			={ name="Intarabus's Cape", augments={'STR+20','Accuracy+20 Attack+20','STR+10','Weapon skill damage +10%',}}
	-- Weapons sets
	sets.weapons.Naegling = {main="Naegling",sub="Kaja Knife"}
    sets.buff.Sublimation = {waist="Embla Sash"}
    sets.buff.DTSublimation = {waist="Embla Sash"}
	
	-- Precast Sets

	-- Fast cast sets for spells
	sets.precast.FC = {
        main=Kali_A, --15
		head="Bunzi's Hat", --10
        body="Inyanga Jubbah +2", --14
        hands=gear.kaykaus_hands, --4
        --hands="Gende. Gages +1", --7
        legs=gear.kaykaus_legs, --6
        feet=gear.kaykaus_feet,
		--feet=BRD_Empy_Feet, --10
        neck="Voltsurge Torque", --4
        lear="Enchntr. Earring +1", --2
        rear="Loquac. Earring", --2
        ring1="Weather. Ring", --5
        ring2="Kishar Ring", --4
        back=JSE_FC_back, --10
        waist="Embla Sash", --5
	}

	sets.precast.FC.Cure = set_combine(sets.precast.FC, {
        hands=gear.kaykaus_hands, --4
        legs=gear.kaykaus_Legs, --6
        feet=gear.kaykaus_feet,
		ear1="Mendi. Earring"
	})

	sets.precast.FC['Enhancing Magic'] = set_combine(sets.precast.FC, {waist="Siegel Sash"})
	sets.precast.FC.Dispelga = set_combine(sets.precast.FC, {main="Daybreak",sub="Genmei Shield"})
	
	sets.precast.FC.BardSong = set_combine(sets.precast.FC, {
		feet=Relic_feet,
		ear2="Aoidos' Earring"
	})

	sets.precast.FC.SongDebuff = set_combine(sets.precast.FC.BardSong,{range="Gjallarhorn"})
	sets.precast.FC.SongDebuff.Resistant = set_combine(sets.precast.FC.BardSong,{range="Daurdabla"})
	sets.precast.FC.Lullaby = {range="Gjallarhorn"}
	sets.precast.FC.Lullaby.Resistant = {range="Daurdabla"}
	sets.precast.FC['Horde Lullaby'] = {range="Gjallarhorn"}
	sets.precast.FC['Horde Lullaby'].Resistant = {range="Daurdabla"}
	sets.precast.FC['Horde Lullaby'].AoE = {range="Daurdabla"}
	sets.precast.FC['Horde Lullaby II'] = {range="Gjallarhorn"}
	sets.precast.FC['Horde Lullaby II'].Resistant = {range="Daurdabla"}
	sets.precast.FC['Horde Lullaby II'].AoE = {range="Daurdabla"}
		
	sets.precast.FC.Mazurka = set_combine(sets.precast.FC.BardSong,{range="Gjallarhorn"})
	sets.precast.FC['Honor March'] = set_combine(sets.precast.FC.BardSong,{range="Marsyas"})

	sets.precast.FC.Daurdabla = set_combine(sets.precast.FC.BardSong, {range=info.ExtraSongInstrument})
	sets.precast.DaurdablaDummy = sets.precast.FC.Daurdabla
		
	
	-- Precast sets to enhance JAs
	
	sets.precast.JA.Nightingale = {feet=Relic_feet}
	sets.precast.JA.Troubadour = {body=Relic_body}
	sets.precast.JA['Soul Voice'] = {legs=Relic_legs}

	-- Waltz set (chr and vit)
	sets.precast.Waltz = {}

	-- Weaponskill sets
	-- Default set for any weaponskill that isn't any more specifically defined
	sets.precast.WS = {ammo="Hasty Pinion +1",
		head="Aya. Zucchetto +2",neck="Caro Necklace",ear1="Moonshade Earring",ear2="Ishvara Earring",
		body="Ayanmo Corazza +2",hands="Aya. Manopolas +2",ring1="Ramuh Ring +1",ring2="Ilabrat Ring",
		back="Ground. Mantle +1",waist="Grunfeld Rope",legs="Aya. Cosciales +2",feet="Aya. Gambieras +2"}
		
	-- Swap to these on Moonshade using WS if at 3000 TP
	sets.MaxTP = {ear1="Ishvara Earring",ear2="Telos Earring",}
	sets.AccMaxTP = {ear1="Mache Earring +1",ear2="Telos Earring"}

	-- Specific weaponskill sets.  Uses the base set if an appropriate WSMod version isn't found.


	-- Midcast Sets

	-- General set for recast times.
	sets.midcast.FastRecast = sets.precast.FC

	-- Gear to enhance certain classes of songs
	sets.midcast.Ballad = {legs=Empy_legs}
	sets.midcast.Lullaby = {range="Gjallarhorn"}
	sets.midcast.Lullaby.Resistant = {range="Daurdabla"}
	sets.midcast['Horde Lullaby'] = {range="Gjallarhorn"}
	sets.midcast['Horde Lullaby'].Resistant = {range="Daurdabla"}
	sets.midcast['Horde Lullaby'].AoE = {range="Daurdabla"}
	sets.midcast['Horde Lullaby II'] = {range="Daurdabla"}
	sets.midcast['Horde Lullaby II'].Resistant = {range="Daurdabla"}
	sets.midcast['Horde Lullaby II'].AoE = {range="Daurdabla"}
	sets.midcast.Madrigal = {head=Empy_head}
	sets.midcast.Paeon = {}
	sets.midcast.March = {hands=Empy_hands}
	sets.midcast['Honor March'] = set_combine(sets.midcast.March,{range="Marsyas"})
	sets.midcast.Minuet = {body=Empy_body}
	sets.midcast.Minne = {}
	sets.midcast.Carol = {}
	sets.midcast["Sentinel's Scherzo"] = {feet=Empy_feet}
	sets.midcast['Magic Finale'] = {range="Daurdabla"}
	sets.midcast.Mazurka = {range="Gjallarhorn"}
	

	-- For song buffs (duration and AF3 set bonus)
	sets.midcast.SongEffect = {
		main=Kali_A,
		sub="Genmei Shield",
		range="Gjallarhorn",
        head=Empy_head,
        body=Empy_body,
        hands=Empy_hands,
        legs="Inyanga Shalwar +2",
        feet=AF_feet,
        neck="Mnbw. Whistle +1",
        lear="Odnowa Earring +1",
        rear="Etiolation Earring",
        ring1="Vocane Ring",
        ring2="Warden's Ring",
        waist="Plat. Mog. Belt",
        back=JSE_FC_back,
	}
	sets.midcast.SongEffect.DW = {main=Kali_A,sub=Kali_B}

	-- For song defbuffs (duration primary, accuracy secondary)
	sets.midcast.SongDebuff = {
		main=Kali_A,
        sub="Ammurapi Shield",
        range="Gjallarhorn",
        head=AF_Head,
        body=AF_body,
        hands=AF_hands,
        legs="Inyanga Shalwar +2",
        feet=AF_feet,
        neck="Null Loop",
        lear="Crep. Earring",
        rear="Fili Earring",
        ring1="Stikini Ring +1",
        ring2="Stikini Ring +1",
        waist="Eschan Stone",
        back="Null Shawl",
	}
	
    sets.midcast.SongDebuff.DW = {main=Kali_A,sub=Kali_B}

	-- For song defbuffs (accuracy primary, duration secondary)
	sets.midcast.SongDebuff.Resistant = set_combine(sets.midcast.SongDebuff, {})

    sets.midcast.SongDebuff.DW = {main=Kali_A,sub=Kali_B}

	-- Song-specific recast reduction
	sets.midcast.SongRecast = sets.precast.FC.BardSong

	-- Cast spell with normal gear, except using Daurdabla instead
    sets.midcast.Daurdabla = {range=info.ExtraSongInstrument}

	-- Dummy song with Daurdabla; minimize duration to make it easy to overwrite.
    sets.midcast.DaurdablaDummy = set_combine(sets.midcast.SongRecast, {range=info.ExtraSongInstrument})

	-- Other general spells and classes.
	sets.midcast.Cure = {
		main="Daybreak", --30
        sub="Ammurapi Shield",
        head="Kaykaus Mitra +1", --11
        body="Kaykaus Bliaut +1", --(+4)/(-6)
        hands=gear.kaykaus_hands, --11(+2)/(-6)
        legs=gear.kaykaus_Legs, --11/(+2)/(-6)
        feet=gear.kaykaus_feet, --11(+2)/(-12)
        neck="Incanter's Torque",
        lear="Beatific Earring",
        rear="Meili. Earring",
        ring1="Menelaus's Ring",
        ring2="Haoma's Ring",
        back="Solemnity Cape", --7
        waist="Bishop's Sash",
	}
		
	sets.midcast.Curaga = sets.midcast.Cure
		
	sets.Self_Healing = {}
	sets.Cure_Received = {}
	sets.Self_Refresh = {}
		
	sets.midcast['Enhancing Magic'] = {
		main="Carnwenhan",
        sub="Ammurapi Shield",
        head=gear.Telchine_ENH_head,
        body=gear.Telchine_ENH_body,
        hands=gear.Telchine_ENH_hands,
        legs=gear.Telchine_ENH_legs,
        feet=gear.Telchine_ENH_feet,
        neck="Incanter's Torque",
        lear="Mimir Earring",
        rear="Andoaa Earring",
        ring1="Stikini Ring +1",
        ring2="Stikini Ring +1",
        back="Fi Follet Cape +1",
        waist="Embla Sash",
	}
		
	sets.midcast.Stoneskin = set_combine(sets.midcast['Enhancing Magic'], {neck="Nodens Gorget",ear2="Earthcry Earring",waist="Siegel Sash",legs="Shedir Seraweels"})
		
	sets.midcast['Elemental Magic'] = {}
	sets.midcast['Elemental Magic'].Resistant = {}
	sets.midcast['Enfeebling Magic'] = {
        main=Kali_A,
        sub="Ammurapi Shield",
        head=empty;
        body="Cohort Cloak +1",
        hands="Brioso Cuffs +2",
        legs="Brioso Cannions +3",
        feet="Brioso Slippers +3",
        neck="Mnbw. Whistle +1",
        lear="Crep. Earring",
        rear="Fili Earring",
        ring1="Kishar Ring",
        ring2="Stikini Ring +1",
        waist="Eschan Stone",
        back="Null Shawl",
    }
	sets.midcast.Cursna =  set_combine(sets.midcast.Cure, {neck="Debilis Medallion",hands="Hieros Mittens",
		back="Oretan. Cape +1",ring1="Haoma's Ring",ring2="Menelaus's Ring",waist="Witful Belt",feet="Vanya Clogs"})
		
	sets.midcast.StatusRemoval = set_combine(sets.midcast.FastRecast, {})

	-- Resting sets
	sets.resting = {}
	
	sets.idle = {
        main="Sangoma",
        sub="Ammurapi Shield",
		head=Empy_head,
        body=Empy_body,
		hands=Empy_hands,
        legs=Empy_legs,
        feet=Empy_feet,
		ring1="Murky Ring",
		ring2="Woltaris Ring",
        neck="Loricate Torque +1",
        lear="Infused Earring",
        rear="Fili Earring",
        back=BRD_MEVA_back,
        waist="Plat. Mog. Belt",
	}
		
	sets.idle.NoRefresh = {}

	sets.idle.DT = {
		head="Nyame Helm", --7/7
        body="Nyame Mail", --9/9
        hands="Nyame Gauntlets", --7/7
        legs="Nyame Flanchard", --8/8
        feet="Nyame Sollerets", --7/7,
        neck="Warder's Charm +1",
        rear="Fili Earring", --4/4
        ring2="Defending Ring", --10/10
        back="Moonlight Cape", --6/6
        waist="Plat. Mog. Belt", --3/3
	}

	sets.idle.Town = set_combine(sets.idle, {
        main="Sangoma",
        sub="Ammurapi Shield",
        head=Empy_head,
        body=Empy_body,
		hands=gear.kaykaus_hands,
        legs=gear.kaykaus_Legs,
        feet=gear.kaykaus_feet,
		ring1="Murky Ring",
		ring2="Stikini Ring +1",
        neck="Bard's Charm +1",
        lear="Alabaster Earring",
        rear="Fili Earring",
        back="Null Shawl",
        waist="Plat. Mog. Belt",
    })
	
	-- Defense sets

	sets.defense.PDT = {}

	sets.defense.MDT = {}

	sets.Kiting = {feet=BRD_Empy_feet}
	sets.latent_refresh = {waist="Fucho-no-obi"}
	sets.latent_refresh_grip = {sub="Oneiros Grip"}
	sets.TPEat = {neck="Chrys. Torque"}

	-- Engaged sets

	-- Variations for TP weapon and (optional) offense/defense modes.  Code will fall back on previous
	-- sets if more refined versions aren't defined.
	-- If you create a set with both offense and defense modes, the offense mode should be first.
	-- EG: sets.engaged.Dagger.Accuracy.Evasion
	
	sets.engaged = {}
	sets.engaged.Acc = {}
	sets.engaged.DW = {}
	sets.engaged.DW.Acc = {}
end

function job_self_command(cmdParams, eventArgs)
    if cmdParams[1]:lower() == 'etude' then
        send_command('@input /ma "'..state.Etude.value..'" <me>')
    elseif cmdParams[1]:lower() == 'carol' then
        send_command('@input /ma "'..state.Carol.value..'" <me>')
    elseif cmdParams[1]:lower() == 'threnody' then
        send_command('@input /ma "'..state.Threnody.value..'" <stnpc>')
    elseif cmdParams[1] == 'playlist' then
        if cmdParams[2] == 'toggle' or cmdParams[2] == 'cycle' then
            state.CurrentPlaylist:cycle()
        elseif cmdParams[2] and playlists[cmdParams[2]] then
            local pl = playlists[cmdParams[2]]
            send_command('gs c set songa '..pl.songa)
            send_command('gs c set songb '..pl.songb)
            send_command('gs c set songc '..pl.songc)
            send_command('gs c set songd '..pl.songd)
            send_command('gs c set songe '..pl.songe)
            state.CurrentPlaylist:set(cmdParams[2])
        else
            add_to_chat(123,'Unknown playlist. Usage: gs c playlist <name|toggle|cycle>')
        end
    elseif cmdParams[1]:lower() == 'sa' then
        send_command('@input /ma "'..sa[state.songa.value]..'" <me>')
    elseif cmdParams[1]:lower() == 'sb' then
        send_command('@input /ma "'..sb[state.songb.value]..'" <me>')
    elseif cmdParams[1]:lower() == 'sc' then
        send_command('@input /ma "'..sc[state.songc.value]..'" <me>')
    elseif cmdParams[1]:lower() == 'sd' then
        send_command('@input /ma "'..sd[state.songd.value]..'" <me>')
    elseif cmdParams[1]:lower() == 'se' then
        send_command('@input /ma "'..se[state.songe.value]..'" <me>')
    end
	if cmdParams[1]:lower() == 'wskill' then
        if WSMap[state.WeaponSet.current] then
            send_command('@input /ws "'..WSMap[state.WeaponSet.current]..'" <t>')
        else
            add_to_chat(123,'No WS defined for weapon: '..state.WeaponSet.current)
        end
    end

    if cmdParams[1]:lower() == 'wskill2' then
        if WSMap[state.WeaponSet.current] then
            send_command('@input /ws "'..WSMap2[state.WeaponSet.current]..'" <t>')
        else
            add_to_chat(123,'No WS defined for weapon: '..state.WeaponSet.current)
        end
    end
end
-- Select default macro book on initial load or subjob change.
function select_default_macro_book()
	set_macro_page(2, 2)
end

-- Called automatically by Mote-Libs whenever a state variable changes.
-- We watch the custom song states and announce the newly selected spell name to party chat.
function job_state_change(stateField, newValue, oldValue)
   if newValue == oldValue then return end
       local key = stateField:lower()
    if key == 'set song a' or key == 'set song b' or key == 'set song c' or key == 'set song d' or key == 'set song e' or key == 'threnody' or key == 'etude' or key == 'carol' then
        --Print just the spell name selected for that slot.
        send_command('@input /t Redviper '..newValue)
    elseif key == 'current playlist' then
        -- Apply the selected playlist
        local pl = playlists[newValue]
        if pl then
            state.songa:set(pl.songa)
            state.songb:set(pl.songb)
            state.songc:set(pl.songc)
            state.songd:set(pl.songd)
            state.songe:set(pl.songe)
            add_to_chat(122,'Playlist changed to: '..newValue)
        end
    end
end
function display_current_job_state(eventArgs)
    local r_msg = state.songa.current
    if state.UseSongB.value == true then
        r_msg = r_msg .. '/'..state.songb.current
    elseif state.UseSongC.value == true then
        r_msg = r_msg .. '/'..state.songc.current
    elseif state.UseSongD.value == true then
        r_msg = r_msg .. '/'..state.songd.current
    elseif state.UseSongE.value == true then
        r_msg = r_msg .. '/'..state.songe.current
    end
end

-- Count currently active Bard song buffs to decide whether slot E should be used

-- Returns true if any bard song buff is active (excluding dummy songs)